tinymce.PluginManager.add('deskphoto', function(editor, url) {
    // Add a button that opens a window
    editor.addButton('bdesk_photo', {
        icon: 'image',
        title: '图片上传',
        onclick: function() {
            // Open window
            editor.windowManager.open({
                //text for dialog							  
                title: "Embed a image",
                width: 450,
                //location:
                height: 80,
                //we need a to put a base64 encode image into texteditor	
                html: '<input type="file" class="input" name="bdesk_image" id="image_embed" style="font-size:14px;padding:30px;" accept="image/x-png, image/gif, image/jpeg"/>',
                buttons: [{
                        text: "Insert",
                        subtype: "primary",
                        /**
                         * Triger a OnClick
                         * @lastchange: $arsalanshah
                         */
                        onclick: function() {
                            if (window.File && window.FileReader && window.FileList && window.Blob) {
                                var imagefile = document.getElementsByName("bdesk_image")[0].files;
                                var class_filereader = new FileReader();
                                for (var i = 0, f; f = imagefile[i]; i++) {
                                    var filesiz = f.size;
                                }
                                if (filesiz > 2048000) {
                                    alert("图片尺寸必须小于2M！");
                                    (this).parent().parent().close();
                                }
                                class_filereader.onload = function(base64) {
                                    if (base64.loaded < 2048000) {
                                        imgData = base64.target.result;
                                        var img = new Image();
                                        img.src = imgData;

                                        editor.execCommand("mceInsertContent", false, "<img src='" + imgData + "' />");
                                        editor.uploadImages();
                                    }
                                };
                                /**
                                 * Log errors
                                 * @lastchange: $arsalanshah
                                 */
                                class_filereader.onerror = function(err) {
                                    console.log("error", err);
                                    console.log(err.getMessage());
                                };
                                if (imagefile.length > 0) {
                                    class_filereader.readAsDataURL(imagefile[0]);
                                } else {
                                    alert("No File selected");
                                }
                            } else {
                                alert("Please change your browser to modern one");
                            }
                            (this).parent().parent().close();
                        }
                    },
                    {
                        text: "Close",
                        onclick: function() {
                            (this).parent().parent().close();
                        }
                    }
                ],
            })
        }
    });
});